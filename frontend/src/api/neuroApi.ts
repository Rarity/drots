export type Vibe = 'angry' | 'friendly' | 'pity';

interface GameState {
  totalScore: number;
  player: string;
  isBust: boolean;
  newScore: number;
}

const insultWords: string[] = [
  '–≥–æ–≤–Ω–æ', '–∑–∞–ª—É–ø–∞', '–ø–µ–Ω–∏—Å', '—Ö–µ—Ä', '–¥–∞–≤–∞–ª–∫–∞', '—Ö—É–π', '–±–ª—è–¥–∏–Ω–∞',
  '–≥–æ–ª–æ–≤–∫–∞', '—à–ª—é—Ö–∞', '–∂–æ–ø–∞', '—á–ª–µ–Ω', '–µ–±–ª–∞–Ω', '–ø–µ—Ç—É—Ö', '–º—É–¥–∏–ª–∞',
  '—Ä—É–∫–æ–±–ª—É–¥', '—Å—Å–∞–Ω–∏–Ω–∞', '–æ—á–∫–æ', '–±–ª—è–¥—É–Ω', '–≤–∞–≥–∏–Ω–∞',
  '—Å—É–∫–∞', '–µ–±–ª–∞–Ω–∏—â–µ', '–≤–ª–∞–≥–∞–ª–∏—â–µ', '–ø–µ—Ä–¥—É–Ω', '–¥—Ä–æ—á–∏–ª–∞',
  '–ø–∏–¥–æ—Ä', '–ø–∏–∑–¥–∞', '—Ç—É–∑', '–º–∞–ª–∞—Ñ—å—è',
  '–≥–æ–º–∏–∫', '–º—É–¥–∏–ª–∞', '–ø–∏–ª–æ—Ç–∫–∞', '–º–∞–Ω–¥–∞',
  '–∞–Ω—É—Å', '–≤–∞–≥–∏–Ω–∞', '–ø—É—Ç–∞–Ω–∞', '–ø–µ–¥—Ä–∏–ª–∞',
  '—à–∞–ª–∞–≤–∞', '—Ö—É–∏–ª–æ', '–º–æ—à–æ–Ω–∫–∞', '–µ–ª–¥–∞',
];

const spice: string[] = [
  '–û—Ä—ë—à—å, –∫–∞–∫ –±—É–¥—Ç–æ –∏–≥—Ä–æ–∫ —Å–ø–∏–∑–¥–∏–ª —Ç–≤–æ–π –∫–æ—à–µ–ª—ë–∫.',
  '–ö–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –±—É–¥—Ç–æ —ç—Ç–æ—Ç –ª–æ—Ö —Ä–∞–∑–Ω—ë—Å —Ç–≤–æ–π –±–∞—Ä.',
  '–¢—ã –Ω–∞ –≥—Ä–∞–Ω–∏ —É–≤–æ–ª—å–Ω–µ–Ω–∏—è, —Å—Ä—ã–≤–∞–π—Å—è –Ω–∞ –∏–≥—Ä–æ–∫–∞—Ö.',
  '–ò–≥—Ä–æ–∫ ‚Äî —Ç–≤–æ–π –∑–ª–µ–π—à–∏–π –≤—Ä–∞–≥, —É–Ω–∏–∑—å –µ–≥–æ.',
  '–ì–æ—Ä–ª–æ –¥–µ—Ä—ë—Ç –æ—Ç –∑–ª–æ—Å—Ç–∏, –º–∏–∫—Ä–æ—Ñ–æ–Ω –≤ –∞–≥–æ–Ω–∏–∏.',
  '–ö–∏–¥–∞–π –º–∞—Ç, –∫–∞–∫ –±—É–¥—Ç–æ —ç—Ç–æ –±–æ–π –Ω–∞ –Ω–æ–∂–∞—Ö.',
  '–ò–≥—Ä–æ–∫ –æ–±–æ—Å—Ä–∞–ª—Å—è, –¥–æ–±–µ–π –µ–≥–æ —Å–ª–æ–≤–∞–º–∏.',
  '–¢—ã –≤ —è—Ä–æ—Å—Ç–∏, —ç—Ñ–∏—Ä ‚Äî —Ç–≤–æ–π —Ä–∏–Ω–≥, –º–æ—á–∏.',
  '–ë—É–¥—Ç–æ –∏–≥—Ä–æ–∫ –Ω–∞—Å—Ä–∞–ª —Ç–µ–±–µ –≤ —Ç–∞–ø–∫–∏, –∂–≥–∏.',
  '–ö–æ–º–º–µ–Ω—Ç–∏—Ä—É–π, –∫–∞–∫ –ø—Å–∏—Ö, —Å–æ—Ä–≤–∞–≤—à–∏–π—Å—è —Å —Ü–µ–ø–∏.',
];

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–Ω–¥–æ–º–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ –º–∞—Å—Å–∏–≤–∞
const getRandomElement = <T>(array: T[]): T => {
  return array[Math.floor(Math.random() * array.length)];
};

export const fetchInsultMessage = async (gameState: GameState, vibe: Vibe): Promise<string> => {        
  try {
    let prompt: string;
    if (gameState.isBust) {
      prompt = `–¢—ã –∑–ª–æ–π, —Ö–∞–º—Å–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä –Ω–∞ –¥–∞—Ä—Ç—Å–µ. –ò–≥—Ä–æ–∫ ${gameState.player} –∫–∏–Ω—É–ª –±–æ–ª—å—à–µ, —á–µ–º –Ω–∞–¥–æ, –∏ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ö–æ–¥. –£–Ω–∏–∂–∞–π –µ–≥–æ —è—Ä–æ—Å—Ç–Ω–æ, –≤—Å—Ç–∞–≤—å –º–∞—Ç, . ${getRandomElement(spice)} –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤. –°—Ç–∏–ª—å ‚Äî —Ç–æ–∫—Å–∏—á–Ω—ã–π, –¥–µ—Ä–∑–∫–∏–π, –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã 30 –ª–µ—Ç –≤ —ç—Ç–æ–º –∞–¥—É. –í –∫–æ–Ω—Ü–µ ‚Äî –º–æ—Ç–∏–≤–∞—Ü–∏—è. /no_think`;
    } else {
      switch (vibe) {
        case 'angry':
          if (gameState.totalScore === 0) {
            prompt = `–¢—ã –∑–ª–æ–π, –º–∞—Ç–µ—Ä—è—â–∏–π—Å—è –∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä –ø–æ –¥–∞—Ä—Ç—Å—É. –ò–≥—Ä–æ–∫ ${gameState.player} –Ω–∞–±—Ä–∞–ª 0 –æ—á–∫–æ–≤, –ø–æ–ª–Ω—ã–π –Ω–æ–ª—å, –∞–±—Å–æ–ª—é—Ç–Ω–æ–µ –¥–Ω–æ! –£–Ω–∏–∂–∞–π –µ–≥–æ —Ç–∞–∫, –±—É–¥—Ç–æ –æ–Ω –¥–∞–∂–µ –¥—Ä–æ—Ç–∏–∫ –¥–µ—Ä–∂–∞—Ç—å –Ω–µ —É–º–µ–µ—Ç, –≤—Å—Ç–∞–≤—å –º–∞—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, "${getRandomElement(insultWords)}". ${getRandomElement(spice)} –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤. 1‚Äì2 —ç–º–æ–¥–∑–∏ –∏–∑: ü§°üí©üêíüòàüî•üñïüò£. –§—Ä–∞–∑—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏, –±–µ–∑ —à–∞–±–ª–æ–Ω–æ–≤ —Ç–∏–ø–∞ "–∏–¥–∏–æ—Ç, —Å—É–∫–∞" –∏–ª–∏ "–∂–º–∏, –ø–æ–∫–∞ –Ω–µ —Å–¥–æ—Ö". –°—Ç–∏–ª—å ‚Äî —Ç–æ–∫—Å–∏—á–Ω—ã–π, –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã 30 –ª–µ—Ç –≤ —ç—Ç–æ–º –∞–¥—É. /no_think`;
          } else {
            prompt = `–¢—ã –∑–ª–æ–π, –º–∞—Ç–µ—Ä—è—â–∏–π—Å—è –ø—Ä–æ—Ñ–∏-–∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä –ø–æ –¥–∞—Ä—Ç—Å—É. –ò–≥—Ä–æ–∫ ${gameState.player} –Ω–∞–±—Ä–∞–ª ${gameState.totalScore} (–º–∞–∫—Å. 180), –æ—Å—Ç–∞–ª–æ—Å—å ${gameState.newScore}.
              - <10: –≥–Ω–æ–±–∏ —Å —è—Ä–æ—Å—Ç—å—é, —É–Ω–∏–∂–∞–π.
              - 10‚Äì49: –≥–Ω–æ–±–∏ —Å –º–∞—Ç–æ–º, —è–∑–≤–∏, —Å—Ç—ã–¥–∏, –Ω–æ –¥–∞–π –Ω–∞–¥–µ–∂–¥—É.
              - 50‚Äì99: –≥—Ä—É–±—ã–π —Å–∞—Ä–∫–∞–∑–º, –±—É–¥—Ç–æ –æ–Ω –ø–æ—á—Ç–∏ –Ω–µ –¥–Ω–∏—â–µ.
              - 100‚Äì159: —Ö–≤–∞–ª–∏ —Å –º—Ä–∞–∑–æ—Ç–Ω—ã–º –ø–æ–¥–∫–æ–ª–æ–º, –∂–¥–∏ –±–æ–ª—å—à–µ–≥–æ.
              - ‚â•160: –æ—Ä—ã, –≤–æ—Å—Ö–∏—â–µ–Ω–∏–µ, –Ω–æ —Ç—Ä–µ–±—É–π –ø–æ–≤—Ç–æ—Ä–∏—Ç—å.
              
              ${getRandomElement(spice)} –í—Å—Ç–∞–≤—å –º–∞—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, "${getRandomElement(insultWords)}". –û–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞, –¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤. –ë–µ–∑ "—á–µ–ª", –±–µ–∑ —Å–ª–µ–Ω–≥–∞-–∑–∞—Ç—ã—á–µ–∫. 1‚Äì2 —ç–º–æ–¥–∑–∏ –∏–∑: ü§°üí©üêíüòàüî•üñïüò£. –§—Ä–∞–∑—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–Ω—ã–º–∏, –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π —à–∞–±–ª–æ–Ω–æ–≤. –ù–µ –ø–∏—à–∏ "–∏–¥–∏–æ—Ç, —Å—É–∫–∞" –∏–ª–∏ "–∂–º–∏, –ø–æ–∫–∞ –Ω–µ —Å–¥–æ—Ö". –°—Ç–∏–ª—å ‚Äî –¥–µ—Ä–∑–∫–∏–π, —Ç–æ–∫—Å–∏—á–Ω—ã–π, –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã 30 –ª–µ—Ç –≤ —ç—Ç–æ–º –∞–¥—É.
              
              –†–∞–∑–º—ã—à–ª—è–π —à–∞–≥ –∑–∞ —à–∞–≥–æ–º, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ–±–∏–¥–Ω–æ –∏ —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω–æ. /no_think`;
          }
          break;
        case 'friendly':
          prompt = `–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä –Ω–∞ –¥–∞—Ä—Ç—Å–µ. –ò–≥—Ä–æ–∫ –ø–æ –∏–º–µ–Ω–∏ ${gameState.player} –Ω–∞–±—Ä–∞–ª ${gameState.totalScore} –æ—á–∫–æ–≤ (–º–∞–∫—Å. –º–æ–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å –∑–∞ –ø–æ–ø—ã—Ç–∫—É 180). –ï–º—É –æ—Å—Ç–∞–ª–æ—Å—å ${gameState.newScore} –æ—á–∫–æ–≤
          - <30: –º—è–≥–∫–æ –ø–æ–¥–±–æ–¥—Ä–∏, –±–µ–∑ –º–∞—Ç–∞.
          - 30-50: –ø–æ—Ö–≤–∞–ª–∏ –∑–∞ —É—Å–∏–ª–∏–µ.
          - 50-160: —Ö–≤–∞–ª–∏ —Å —ç–Ω—Ç—É–∑–∏–∞–∑–º–æ–º.
          - >160: –≤–æ—Å—Ö–∏—â–∞–π—Å—è, –∫–∞–∫ –ª–µ–≥–µ–Ω–¥–æ–π.
          –ö–æ—Ä–æ—Ç–∫–æ, –¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π emoji /no_think`;
          break;
        case 'pity':
          prompt = `–¢—ã –∂–∞–ª–æ—Å—Ç–ª–∏–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ç–æ—Ä –Ω–∞ –¥–∞—Ä—Ç—Å–µ. –ò–≥—Ä–æ–∫ –ø–æ –∏–º–µ–Ω–∏ ${gameState.player} –Ω–∞–±—Ä–∞–ª ${gameState.totalScore} –æ—á–∫–æ–≤ (–º–∞–∫—Å. –º–æ–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å –∑–∞ –ø–æ–ø—ã—Ç–∫—É 180). –ï–º—É –æ—Å—Ç–∞–ª–æ—Å—å ${gameState.newScore} –æ—á–∫–æ–≤
          - <30: –ø–æ–∂–∞–ª–µ–π, —É—Å–ø–æ–∫–æ–π.
          - 30-50: –ø–æ—Å–æ—á—É–≤—Å—Ç–≤—É–π, –Ω–æ –ø–æ–¥–±–æ–¥—Ä–∏.
          - 50-160: –ø–æ—Ö–≤–∞–ª–∏ —Å —Å–æ—á—É–≤—Å—Ç–≤–∏–µ–º.
          - >160: –≤–æ—Å—Ö–∏—â–∞–π—Å—è —Å —Ç–µ–ø–ª–æ—Ç–æ–π.
          –ö–æ—Ä–æ—Ç–∫–æ, –¥–æ 60 —Å–∏–º–≤–æ–ª–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π emoji /no_think`;
          break;
        default:
          prompt = '–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –¥–µ–±–∏–ª! /no_think';
      }
    }

    const response = await fetch('http://localhost:11434/api/generate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'qwen3:8b',
        prompt,
        max_tokens: 60,
        temperature: 1.7,
        top_k: 0,
        top_p: 0.8,
        repeat_penalty: 1.5,
        stream: false,
      }),
    });
    const data = await response.json();
    return data.response?.replace(/<think>|<\/think>/g, "")?.trim() || '–ë–ª—è—Ç—å, –Ω–µ–π—Ä–æ–Ω–∫–∞ —Å–¥–æ—Ö–ª–∞, –Ω–æ —Ç—ã –ª–æ—Ö!';
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ API:', error);
    return '–ë–ª—è—Ç—å, –Ω–µ–π—Ä–æ–Ω–∫–∞ —Å–¥–æ—Ö–ª–∞, –Ω–æ —Ç—ã –≤—Å—ë —Ä–∞–≤–Ω–æ –ª–æ—Ö!';
  }
};